<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent Details</title>

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h2 {
      margin-bottom: 20px;
    }

    table.dataTable thead th {
      background: #09b367;
      color: white;
      text-align: center;
    }

    table.dataTable tbody td {
      text-align: center;
    }

    /* Comments column styling */
    .comments-cell {
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .comments-cell.expanded {
      white-space: normal;
      overflow: visible;
    }

    /* Make filters look cleaner */
    .filter-select {
      width: 100% !important;
    }
  </style>
</head>
<body>
  <h2 id="agentTitle">Agent Details</h2>

  <table id="detailsTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Trail ID</th>
        <th>Converted Date</th>
        <th>Region</th>
        <th>Dept day band</th>
        <th>Pending Reason</th>
        <th>Updated band</th>
        <th>Additional Comments</th>
      </tr>
      <!-- Filter row will be injected here -->
    </thead>
    <tbody></tbody>
  </table>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <!-- Select2 -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // Escape HTML helper
    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
    }

    $(document).ready(function () {
      // Parse agent name from URL
      const params = new URLSearchParams(window.location.search);
      const agentName = params.get("agent");
      $("#agentTitle").text(`Agent Details - ${agentName}`);

      // Dummy data (replace with your actual sheet parsing logic)
      const rowsForAgent = [
        {
          trail: "TR123",
          date: "2025-09-10",
          region: "Europe",
          dept: "<10 days",
          reason: "Awaiting Docs",
          updated: "1 day ago",
          comments: "Customer asked for urgent update, long notes go here for testing text wrapping..."
        },
        {
          trail: "TR456",
          date: "2025-09-12",
          region: "Asia",
          dept: "<5 days",
          reason: "Pending Payment",
          updated: "Today",
          comments: "Payment pending since last week, escalation required."
        }
      ];

      // Populate table
      rowsForAgent.forEach(r => {
        $("#detailsTable tbody").append(`
          <tr>
            <td>${escapeHtml(r.trail)}</td>
            <td>${escapeHtml(r.date)}</td>
            <td>${escapeHtml(r.region)}</td>
            <td>${escapeHtml(r.dept)}</td>
            <td>${escapeHtml(r.reason)}</td>
            <td>${escapeHtml(r.updated)}</td>
            <td class="comments-cell">${escapeHtml(r.comments)}</td>
          </tr>
        `);
      });

      // Add filter row
      $("#detailsTable thead").append('<tr class="filters"></tr>');
      $("#detailsTable thead tr:eq(0) th").each(function () {
        $(".filters").append('<th><select class="filter-select" multiple><option value="">All</option></select></th>');
      });

      // Initialize DataTable
      const table = $("#detailsTable").DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        initComplete: function () {
          this.api().columns().every(function () {
            const column = this;
            const select = $(".filter-select").eq(column.index());

            // Populate unique options
            column.data().unique().sort().each(function (d) {
              if (d) {
                select.append('<option value="' + d + '">' + d + '</option>');
              }
            });

            // Apply Select2
            select.select2({ width: "100%" });

            // Filtering logic
            select.on("change", function () {
              const vals = $(this).val();
              if (vals && vals.length > 0) {
                const regex = vals.map(v => $.fn.dataTable.util.escapeRegex(v)).join("|");
                column.search(regex, true, false).draw();
              } else {
                column.search("", true, false).draw();
              }
            });
          });
        }
      });

      // Expand/Collapse comments on click
      $("#detailsTable").on("click", ".comments-cell", function () {
        $(this).toggleClass("expanded");
      });
    });
  </script>
</body>
</html>
