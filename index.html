<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Won Trails â€” Summary</title>

  <!-- Bootstrap + DataTables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Manrope + styling -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --brand: #09b367; }
    body { font-family: 'Manrope', sans-serif; background: #f9fafb; color: #222; }
    .container { max-width: 960px; }
    h1 { color: var(--brand); font-weight:700; text-align:center; margin:28px 0; }
    .card { border-radius:12px; box-shadow:0 6px 14px rgba(0,0,0,0.06); padding:18px; background:#fff; }
    .table thead th { background:var(--brand); color:#fff; text-align:center; }
    .table td, .table th { vertical-align: middle; text-align:center; }
    .btn-primary { background: var(--brand); border-color: var(--brand); }
    .tfoot-total { font-weight:700; background:#f1f6f2; }
    .small-muted { color:#666; font-size:0.9rem; }
    .top-actions { display:flex; justify-content:flex-end; margin-bottom:12px; gap:10px; }
  </style>
</head>
<body>
  <div class="container mt-4 mb-5">
    <h1>Won Trails Summary</h1>

    <!-- TC View button -->
    <div class="top-actions">
      <a href="tcview.html" class="btn btn-primary btn-sm">TC View</a>
    </div>

    <div class="card">
      <div class="small-muted mb-2">This view shows unique Trail ID counts per Agent (Status = Won). Click <strong>View</strong> to see details.</div>

      <table id="summaryTable" class="table table-striped table-hover">
        <thead>
          <tr><th>Agent</th><th>Won Count</th><th>Details</th></tr>
        </thead>
        <tbody id="summaryBody"></tbody>
        <tfoot>
          <tr class="tfoot-total">
            <td>Total</td>
            <td id="totalWon"></td>
            <td><a href="master.html" class="btn btn-primary btn-sm">Master View</a></td>
          </tr>
        </tfoot>
      </table>

      <div class="small-muted">Data auto-loaded from Google Sheets CSV. If nothing appears, check CSV URL or publish settings.</div>
    </div>
  </div>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
  // === CONFIG ===
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2olHcvBurEJqZacnbuCGab0BOjTsm2-Hkzdj-HVoTAWtMAWhk3CVR1p4m6_Ld5IQCpdJ9DSBKYzhV/pub?gid=1446258632&single=true&output=csv";

  const COL_TRAIL = 'trail id';
  const COL_AGENT = 'agent';
  const COL_STATUS = 'status';

  function mapRowByLowerKeys(row) {
    const mapped = {};
    for (const k in row) {
      mapped[k.trim().toLowerCase()] = (row[k] === undefined || row[k] === null) ? '' : String(row[k]).trim();
    }
    return mapped;
  }

  Papa.parse(SHEET_CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      const raw = results.data;
      if (!raw || raw.length === 0) {
        document.getElementById('summaryBody').innerHTML = '<tr><td colspan="3">No data found (check CSV URL or publishing).</td></tr>';
        return;
      }

      const agentMap = {};
      for (const r of raw) {
        const row = mapRowByLowerKeys(r);
        const status = (row[COL_STATUS] || '').toLowerCase();
        if (status !== 'won') continue;
        const agent = row[COL_AGENT] || 'Unknown';
        if (agent === 'Aswin PB') continue; // ðŸš« Skip Aswin PB
        const trail = row[COL_TRAIL] || '(no-id)';
        if (!agentMap[agent]) agentMap[agent] = new Set();
        agentMap[agent].add(trail);
      }

      const arr = Object.entries(agentMap).map(([agent, s]) => ({ agent, count: s.size }));
      arr.sort((a,b) => b.count - a.count);

      const tbody = document.getElementById('summaryBody');
      tbody.innerHTML = '';
      let total = 0;
      for (const row of arr) {
        total += row.count;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.agent}</td>
          <td>${row.count}</td>
          <td><a class="btn btn-primary btn-sm" href="agent.html?agent=${encodeURIComponent(row.agent)}">View</a></td>
        `;
        tbody.appendChild(tr);
      }
      document.getElementById('totalWon').textContent = total;
    },
    error: function(err) {
      document.getElementById('summaryBody').innerHTML = '<tr><td colspan="3">Error loading CSV. Check URL & publish settings.</td></tr>';
      console.error(err);
    }
  });
  </script>
</body>
</html>
