<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agent Details</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --brand: #09b367; }
    body { font-family: 'Manrope', sans-serif; background:#f9fafb; color:#222; }
    .container { max-width: 1150px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin:18px 0; }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 6px 14px rgba(0,0,0,0.06); }
    h2 { color:var(--brand); font-weight:700; text-align:center; margin-bottom:14px; }
    table.dataTable thead th { background: var(--brand); color:#fff; text-align:center; }
    table.dataTable tbody td { text-align:center; vertical-align:middle; }
    .filter-select, .filter-input { width:100%; margin-top:6px; padding:6px; }
  </style>
</head>
<body>
  <div class="container mt-3">
    <div class="topbar">
      <a class="btn btn-outline-secondary" href="index.html">&larr; Back</a>
      <div id="agentTitle"></div>
      <a id="gform" class="btn" target="_blank" style="background:var(--brand); color:#fff;">Update Latest Remark</a>
    </div>

    <div class="card">
      <h2 id="hAgent"></h2>

      <table id="detailsTable" class="table table-striped display" style="width:100%">
        <thead>
          <tr>
            <th>Trail ID</th>
            <th>Region</th>
            <th>Pending Reason</th>
            <th>Updated band</th>
            <th>Dept day band</th>
          </tr>
          <!-- we will insert a filter row programmatically -->
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <script>
  // === CONFIG ===
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2olHcvBurEJqZacnbuCGab0BOjTsm2-Hkzdj-HVoTAWtMAWhk3CVR1p4m6_Ld5IQCpdJ9DSBKYzhV/pub?gid=1446258632&single=true&output=csv";
  const GOOGLE_FORM_URL = "https://forms.gle/EtV5VLiMwMsZ6geN8"; // replace
  const EXPECTED_STATUS = 'won';

  // Helper to get query param
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  // Map header rows to lower-case keys
  function mapRowByLowerKeys(row) {
    const mapped = {};
    for (const k in row) mapped[k.trim().toLowerCase()] = (row[k] || '').toString().trim();
    return mapped;
  }

  // Run
  (function(){
    const agentName = getParam('agent') || '';
    if (!agentName) {
      document.getElementById('hAgent').textContent = 'No agent selected';
      return;
    }
    document.getElementById('hAgent').textContent = agentName;
    document.getElementById('gform').href = GOOGLE_FORM_URL;

    Papa.parse(SHEET_CSV_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const raw = results.data;
        const rowsForAgent = [];

        for (const r of raw) {
          const row = mapRowByLowerKeys(r);
          if ((row['agent'] || '') === agentName && (row['status'] || '').toLowerCase() === EXPECTED_STATUS) {
            rowsForAgent.push({
              trail: row['trail id'] || row['trailid'] || '',
              region: row['region'] || '',
              reason: row['pending reason'] || row['pendingreason'] || '',
              updated: row['updated band'] || row['updatedband'] || row['last updated'] || '',
              dept: row['dept day band'] || row['deptdayband'] || ''
            });
          }
        }

        // Build table body
        const tbody = $('#detailsTable tbody');
        tbody.empty();
        rowsForAgent.forEach(r => {
          tbody.append(`<tr>
            <td>${escapeHtml(r.trail)}</td>
            <td>${escapeHtml(r.region)}</td>
            <td>${escapeHtml(r.reason)}</td>
            <td>${escapeHtml(r.updated)}</td>
            <td>${escapeHtml(r.dept)}</td>
          </tr>`);
        });

        // Insert filter row directly beneath header
        if ($('#detailsTable thead tr.filter-row').length === 0) {
          const filterRow = $('<tr class="filter-row"></tr>');
          filterRow.append('<th><input type="text" class="filter-input" placeholder="Search Trail ID" /></th>');
          filterRow.append('<th><select class="filter-select"><option value="">All</option></select></th>');
          filterRow.append('<th><input type="text" class="filter-input" placeholder="Search Pending Reason" /></th>');
          filterRow.append('<th><input type="text" class="filter-input" placeholder="Search Updated band" /></th>');
          filterRow.append('<th><select class="filter-select"><option value="">All</option></select></th>');
          $('#detailsTable thead').append(filterRow);
        }

        // Initialize DataTable
        const table = $('#detailsTable').DataTable({
          orderCellsTop: true,
          fixedHeader: true,
          pageLength: 10,
          lengthChange: true
        });

        // Setup filtering
        $('#detailsTable thead tr.filter-row th').each(function (i) {
          const column = table.column(i);

          // populate selects with unique values (for select columns)
          const select = $(this).find('select');
          if (select.length) {
            column.data().unique().sort().each(function (d) {
              if (d !== '' && select.find('option[value="'+d+'"]').length === 0) {
                select.append('<option value="'+escapeHtml(d)+'">'+escapeHtml(d)+'</option>');
              }
            });
            select.on('change', function () {
              const val = $.fn.dataTable.util.escapeRegex($(this).val());
              column.search(val ? '^'+val+'$' : '', true, false).draw();
            });
          }

          // inputs
          const input = $(this).find('input');
          if (input.length) {
            input.on('keyup change clear', function () {
              if (column.search() !== this.value) column.search(this.value).draw();
            });
          }
        });

      },
      error: function(err){
        console.error(err);
        $('#detailsTable tbody').html('<tr><td colspan="5">Error loading CSV. Check URL/publish settings.</td></tr>');
      }
    });

    // escape helper
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  })();
  </script>
</body>
</html>